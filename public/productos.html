<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Almacenes Wenas</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">

  <link rel="stylesheet" href="styles/style.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="index.html" class="nav-link">Home</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Contact</a>
      </li>
    </ul>

  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index.html" class="brand-link">
      <img src="dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">Almacenes Wenas</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="https://i.pinimg.com/474x/97/a1/7a/97a17a1178ec01c219657992db8c97f3.jpg" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">Usuario</a>
        </div>
      </div>

      <!-- SidebarSearch Form -->
      <div class="form-inline">
        <div class="input-group" data-widget="sidebar-search">
          <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
          <div class="input-group-append">
            <button class="btn btn-sidebar">
              <i class="fas fa-search fa-fw"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item">
            <a href="productos.html" class="nav-link">
              <i class="nav-icon fas fa-th"></i>
              <p>
                Productos
              </p>
            </a>
          </li>

          <li class="nav-item">
            <a href="categorias.html" class="nav-link">
              <i class="nav-icon fas fa-th"></i>
              <p>
                Categorias
              </p>
            </a>
          </li>

          <li class="nav-item">
            <a href="clientes.html" class="nav-link">
              <i class="nav-icon fas fa-th"></i>
              <p>
                Clientes
              </p>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
   
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
<!-- Button trigger modal -->
<div class="d-flex m-3">
 <!-- <button type="button" class="btn btn-primary mx-auto" id="myInput" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Añadir producto
  </button> -->
  <button class="download-button mx-auto" id="myInput">
    <div class="docs"><svg class="css-i6dzq1" stroke-linejoin="round" stroke-linecap="round" fill="none" stroke-width="2" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line y2="13" x2="8" y1="13" x1="16"></line><line y2="17" x2="8" y1="17" x1="16"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Añadir producto</div>
    <div class="download">
      <svg class="css-i6dzq1" stroke-linejoin="round" stroke-linecap="round" fill="none" stroke-width="2" stroke="currentColor" height="24" width="24" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line y2="3" x2="12" y1="15" x1="12"></line></svg>
    </div>
  </button>
</div>

<!-- Modal -->
<div class="modal" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Añadir producto</h5>
    </div>

      <div class="modal-body ">
        <label for="product_id" class="col-form-label">Id:</label>
        <input type="text" class="form-control" id="product_id" readonly>

        <label for="product_name" class="col-form-label">Nombre del producto:</label>
        <input type="text" class="form-control" id="product_name">

        <label for="supplier_id" class="col-form-label">Id proveedor:</label>
        <input type="number" class="form-control" id="supplier_id">

        <label for="category_id" class="col-form-label">Id categoria:</label>
        <input type="number" class="form-control" id="category_id">

        <label for="quantity_per_unit" class="col-form-label">Cantidad por unidad:</label>
        <input type="text" class="form-control" id="quantity_per_unit">

        <label for="unit_price" class="col-form-label">Precio por unidad:</label>
        <input type="number" step="0.01" class="form-control" id="unit_price">

        <label for="units_in_stock" class="col-form-label">Unidades en stock:</label>
        <input type="number" class="form-control" id="units_in_stock">

        <label for="units_on_order" class="col-form-label">Unidades pedidas:</label>
        <input type="number" class="form-control" id="units_on_order">

        <label for="reorder_level" class="col-form-label">Nivel de pedidos:</label>
        <input type="number" class="form-control" id="reorder_level">

        <label for="discontinued" class="col-form-label">Descatalogados: </label>
        <input type="number" class="form-control" id="discontinued">

      </div>
      <div class="modal-footer">
        <button type="button" id="closeModal" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="anadirProducto" class="btn btn-primary">Añadir producto</button>
      </div>
    </div>
  </div>
</div>
        <div class="row p-5">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Productos</h3>

                <div class="card-tools">
                  <div class="input-group input-group-sm" style="width: 150px;">
                    <input type="text" name="table_search" class="form-control float-right" placeholder="Search">

                    <div class="input-group-append">
                      <button type="submit" class="btn btn-default">
                        <i class="fas fa-search"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.card-header -->
              <div class="card-body table-responsive p-0" style="height: 300px;">
                <table class="table table-head-fixed text-nowrap table-hover">
                  <thead>
                    <tr>
                      <th>Category id</th>
                      <th>Discontinued</th>
                      <th>Product id</th>
                      <th>Product name</th>
                      <th>Quantity per unit</th>
                      <th>Reorder level</th>
                      <th>Suplier id</th>
                      <th>Unit price</th>
                      <th>Units in stock</th>
                      <th>Units on order</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="cuerpoTabla">
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
        </div>
        <!-- /.row -->
        </div>
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">
      <b>Version</b> 3.2.0
    </div>
    <strong>Copyright &copy; 2023 Raquel, Xavi i Júlia.</strong> All rights reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<script defer>

document.addEventListener('DOMContentLoaded', function() {

  showProducts();

  function showProducts(){
    fetch('/api/productos')
    .then(response => response.json())
    .then((data) => {
      console.log(data);
      data.forEach(element => {
        
        let tbody = document.getElementById('cuerpoTabla');
        let tr = document.createElement('tr');

        let categoryId = document.createElement('td');
        categoryId.innerHTML = element.category_id;
        tr.appendChild(categoryId);

        let discounted = document.createElement('td');
        discounted.innerHTML = element.discontinued;
        tr.append(discounted);
        
        let productId = document.createElement('td');
        productId.innerHTML = element.product_id;
        tr.append(productId);

        let productName = document.createElement('td');
        productName.innerHTML = element.product_name;
        tr.append(productName);

        let quantityPerUnit = document.createElement('td');
        quantityPerUnit.innerHTML = element.quantity_per_unit;
        tr.append(quantityPerUnit);

        let reorderLevel = document.createElement('td');
        reorderLevel.innerHTML = element.reorder_level;
        tr.append(reorderLevel);

        let supplierId = document.createElement('td');
        supplierId.innerHTML = element.supplier_id;
        tr.append(supplierId);

        let unitPrice = document.createElement('td');
        unitPrice.innerHTML = element.unit_price;
        tr.append(unitPrice);
        
        let unitsInStock = document.createElement('td');
        unitsInStock.innerHTML = element.units_in_stock;
        tr.append(unitsInStock);

        let unitsOnOrder = document.createElement('td');
        unitsOnOrder.innerHTML = element.units_on_order;
        tr.append(unitsOnOrder);

        let acciones = document.createElement('td');
        let eliminar = document.createElement('a');
        let iconEliminar = document.createElement('i');
        iconEliminar.classList.add('fas', 'fa-trash-alt', 'm-2');
        eliminar.addEventListener('click', () => deleteProduct(element.product_id));
        eliminar.appendChild(iconEliminar);
        
        let editar = document.createElement('a');
        let iconEditar = document.createElement('i');
        iconEditar.classList.add('fas', 'fa-edit', 'm-2');
        editar.addEventListener('click', (e) => editModal(e, element));
        editar.appendChild(iconEditar);

        acciones.append(editar);
        acciones.append(eliminar);
        tr.append(acciones);

        tbody.append(tr);
      });
    });
  }
 
    const myModal = document.getElementById('exampleModal');
    const myInput = document.getElementById('myInput');
    const closeModal = document.getElementById('closeModal');
    const saveChanges = document.getElementById('anadirProducto');
    const title = document.querySelector('.modal-title');

    myInput.addEventListener('click', () => {
      myModal.style.display = 'block';
      saveChanges.innerHTML = "Guardar producto";
      title.innerHTML = "Guardar producto"
      cleanForm();
    });

    closeModal.addEventListener('click', () => {
      myModal.style.display = 'none';
    });

    function editModal(e, element) {
      e.target.addEventListener('click', () => {
        cleanForm();
        myModal.style.display = 'block';
        saveChanges.innerHTML = "Modificar producto";
        title.innerHTML = "Modificar producto"
        anadirDatosFormulario(element);
      });
    }

  function anadirDatosFormulario(producto){

    document.getElementById('product_id').value = producto.product_id;
    document.getElementById('product_name').value = producto.product_name;
    document.getElementById('supplier_id').value = producto.supplier_id;
    document.getElementById('category_id').value = producto.category_id;
    document.getElementById('quantity_per_unit').value = producto.quantity_per_unit;
    document.getElementById('unit_price').value = producto.unit_price;
    document.getElementById('units_in_stock').value = producto.units_in_stock;
    document.getElementById('units_on_order').value = producto.units_on_order;
    document.getElementById('reorder_level').value = producto.reorder_level;
    document.getElementById('discontinued').value = producto.discontinued;

  }

  document.getElementById('anadirProducto').addEventListener('click', (e) => handleProductAction(e));

  function handleProductAction(e){
   
    let product = {
      'product_name': document.getElementById('product_name').value,
      'supplier_id': document.getElementById('supplier_id').value,
      'category_id': document.getElementById('category_id').value,
      'quantity_per_unit': document.getElementById('quantity_per_unit').value,
      'unit_price' :document.getElementById('unit_price').value,
      'units_in_stock': document.getElementById('units_in_stock').value,
      'units_on_order': document.getElementById('units_on_order').value,
      'reorder_level': document.getElementById('reorder_level').value,
      'discontinued': document.getElementById('discontinued').value
    }

    if(e.target.innerHTML == "Añadir producto"){

      addProduct(product);

    } else if (saveChanges.innerHTML == "Modificar producto"){

    product.product_id = document.getElementById('product_id').value;

      editProduct(product);

    }

    myModal.style.display = 'none';
  }

  //TODO probar loading
  function cleanForm(){
    document.getElementById('product_id').value = "";
    document.getElementById('product_name').value = "";
    document.getElementById('supplier_id').value = "";
    document.getElementById('category_id').value = "";
    document.getElementById('quantity_per_unit').value = "";
    document.getElementById('unit_price').value = "";
    document.getElementById('units_in_stock').value = "";
    document.getElementById('units_on_order').value = "";
    document.getElementById('reorder_level').value = "";
    document.getElementById('discontinued').value = "";
  }

  function editProduct(product) {

    fetch(`/api/productos`, {
    method: 'PUT',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(product)
  })
  .then(response => {
    if (response.ok) {
      console.log(`Se ha modificado el producto correctamente`);
    } else {
      throw new Error(`No se ha modificado el producto`);
    }
  })
  .catch(error => console.error(error));
    
  }

  function addProduct(product) {

  fetch(`/api/productos`, {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(product)
  })
  .then(response => {
    if (response.ok) {
      console.log(`Se ha añadido el producto correctamente`);
    } else {
      throw new Error(`No se ha añadido el producto`);
    }
  })
  .catch(error => console.error(error));
}

function deleteProduct(id) {

 let response =  confirm('¿Estás seguro que quieres eliminar el producto?')

 if(response){
  fetch(`/api/productos/${id}`, {
      method: 'DELETE'
    })
    .then(response => {
      if (response.ok) {
        console.log(`Se ha borrado el producto con el ID ${id}`);
      } else {
        throw new Error(`No se ha podido borrar el producto con el ID ${id}`);
      }
    })
    .catch(error => console.error(error));
  }
 }
});

</script>

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>


</body>

</html>
